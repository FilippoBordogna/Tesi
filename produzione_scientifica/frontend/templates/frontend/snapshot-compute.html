{% extends 'base.html' %} <!-- estendo il file base.html (Scheletro) -->

{% block title %}Statistiche del gruppo{% endblock title %} <!-- estensione titolo -->

{% block onload %}
    {% if user.is_authenticated %} 
       onload="buildSnapshot();"
    {% endif %}
{% endblock onload %} <!-- Estensione funzione onload -->


{% block content %} <!-- Estensione contenuto del body -->
    {% if user.is_authenticated %}
        <div id="items-container">
            <div id="form-wrapper">
                <h2>Caricamento delle statistiche ...</h2>
            </div>
            <div id="item-wrapper">
                <div class='element-wrapper'>
                    <h2><b>Valori metrici</b></h2>
                    <canvas id="myChart"></canvas>
                    <table id="data-table"> <!-- Tabella che conterrà gli autori-->
                        <tr>
                            <th>Dato</th>
                            <th>Valore</th>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="item-wrapper">
                <div onclick='history.back()' class='element-wrapper link-td'>Indietro</div>
                <div class='element-wrapper'>
                    <h2><b>Lista Autori</b></h2>
                    <table id="item-table"> <!-- Tabella che conterrà gli autori-->
                        <tr>
                            <th>Id</th>
                            <th>Autore</th>
                        </tr>
                    </table>
                </div>
                <div id="form-wrapper" name="snapshot-form" style="display: none;">
                    <form id="form"> <!-- Form tramite la quale creo / modifico un gruppo -->
                        <div class="flex-wrapper">
                            <div style="flex: 6">
                                <input id="title" class="form-control" type="text" name="title" placeholder="Titolo dello snapshot">
                            </div>
                            <div style="flex: 1">
                                <input id="submit" class="btn" type="submit" value="Salva snapshot">
                            </div>
                        </div>
                        <div class="flex-wrapper" style="display: none; color: green;" id="save-status">
                            Il salvataggio è andato a buon fine. <a href="{% url 'frontend:snapshots-list' %}">Qui</a> potrai confrontare questo snapshot con altri
                        </div>
                    </form>
                </div>
            </div>
            <div onclick='history.back()' class='element-wrapper link-td'>Indietro</div>
        </div>
    {% else %}
        {% include 'components/not_logged.html' %} <!-- Link login e registrazione -->
    {% endif %}
{% endblock content %}

{% block other %} <!-- Estensione -->
    <script type="text/javascript">
        function getCookie(name) { // Dato il nome del cookie mi restituisce il valore
            var cookieValue = null
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';')
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim()
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken') // Valore del Token CSFR per effettuare le chiamate API con metodo diverso dalla GET
        var snapshot_json = null // contenuto dello snapshot che in caso di salvataggio passerò all'API

        function buildSnapshot(){ // Populo il div chiamato item-wrapper con i gruppi creati dall'utente
            var url = '{% url 'api:snapshot-compute' "replace_id" %}'; // URL della API che restituisce lo snapshot del gruppo
            var url = url.replace("replace_id",{{groupId}}) // sostituisco replace_id con l'id dell'autore 

            fetch(url) // Chiamata
            .then((resp) => resp.json()) // Conversione in JSON della risposta
            .then(function(data){ // Funzione che lavora coi dati della risposta convertiti
                snapshot_json = data
                console.log('Snapshot:', data) // Scrittura di debug
                var form_wrapper = document.getElementById("form-wrapper")
                form_wrapper.innerHTML = "<h2>Statistiche del gruppo "+data.groupName+"</h2>"
                var lista = data.groupAuthors
                table = document.getElementById("item-table")
                console.log(lista.length)
                if (lista.length==0){ // Non ci sono autori
                    wrapper = document.getElementById("item-wrapper")
                    wrapper.innerHTML = `   
                                                                            <div class="element-wrapper">
                                                                                <h2>Non sono ancora presenti autori nel gruppo.</h2>
                                                                                <a href="#">Comincia ad aggiungerne</a>
                                                                            </div>
                                                                        `
                    
                }else {
                    for(var i in lista){ // Ciclo fra gli autori
                        console.log(i+": "+lista[i].scopusId+": "+lista[i].full_name)
                        j = parseInt(i)
                        var row = table.insertRow(j+1) // Inserisco 1 riga
                        row.id = "author-"+lista[j].id // id della riga
                        var id = row.insertCell(0) // Inserisco 1 cella in posizione 0
                        id.innerHTML = lista[j].scopusId
                        var full_name = row.insertCell(1) // Inserisco 1 cella in posizione 1
                        full_name.innerHTML = lista[j].surname+" "+lista[j].name
                        full_name.className = "link-td full_name" // Assegno la classe al td (servirà per il .css)                      
                    }

                    for(var i in lista){ // Ciclo fra i gruppi
                        var fn = document.getElementsByClassName('full_name')[i]

                        fn.addEventListener('click', (function(scopusId){ // Aggiungo il listener sull'evento di click del bottone Edit
                            return function(){
                                redirectAuthorDetail(scopusId)
                            }
                        })(lista[i].scopusId))
                    }
                    // Creazione del grafico
                    var xValues = ["Citazioni a documenti", "Citazioni ad autori", "Numero di documenti"];
                    var yValues = [data.tot_citation_count, data.tot_cited_by_count, data.tot_document_count];
                    var barColors = [
                    "#b91d47",
                    "#00aba9",
                    "#2b5797",
                    ];

                    new Chart("myChart", {
                    type: "pie",
                    data: {
                        labels: xValues,
                        datasets: [{
                        backgroundColor: barColors,
                        data: yValues
                        }]
                    },
                    options: {
                        title: {
                        display: true,
                        text: "Statistiche metriche al " + data.timestamp.split("_")[0] 
                        }
                    }
                    });
                    //document.getElementById("h-index").innerHTML = "<div class='element-wrapper'><b>Indice di produttività H: "+data.tot_h_index+"</b></div>"

                    var data_table = document.getElementById("data-table")
                    var row = data_table.insertRow(1) // Inserisco 1 riga
                    var title = row.insertCell(0) // Inserisco 1 cella in posizione 0
                    title.innerHTML = "Indice di produttività H".bold()
                    var h_index = row.insertCell(1) // Inserisco 1 cella in posizione 1
                    h_index.innerHTML = data.tot_h_index.toString().bold()

                    var row = data_table.insertRow(2) // Inserisco 1 riga
                    var title = row.insertCell(0) // Inserisco 1 cella in posizione 0
                    title.innerHTML = "Citazioni a documenti"
                    var doc_cit = row.insertCell(1) // Inserisco 1 cella in posizione 1
                    doc_cit.innerHTML = data.tot_citation_count

                    var row = data_table.insertRow(3) // Inserisco 1 riga
                    var title = row.insertCell(0) // Inserisco 1 cella in posizione 0
                    title.innerHTML = "Citazioni ad autori"
                    var auth_cit = row.insertCell(1) // Inserisco 1 cella in posizione 1
                    auth_cit.innerHTML = data.tot_cited_by_count

                    var row = data_table.insertRow(4) // Inserisco 1 riga
                    var title = row.insertCell(0) // Inserisco 1 cella in posizione 0
                    title.innerHTML = "Numero di documenti prodotti"
                    var doc_cit = row.insertCell(1) // Inserisco 1 cella in posizione 1
                    doc_cit.innerHTML = data.tot_document_count

                    document.getElementsByName("snapshot-form")[0].style.display = "block";
                }
            })
        }

        var form = document.getElementsByName('snapshot-form')[0]
        form.addEventListener('submit', function(e){ // Aggiungo il listener sull'evento di submit
            e.preventDefault() // Evito che effettui il submit di default
            console.log(snapshot_json) // Scrittura di debug
            title = document.getElementById("title").value;
            console.log(title)
            var url = '{% url 'api:snapshot-save' "replace_id" %}' // URL dell'API che crea un gruppo
            url = url.replace('replace_id', title)
            //snapshot_json = JSON.parse(snapshot_json)
            fetch(url, { // Chiamata
                method:'POST', // Metodo
                headers:{
                    'Content-type':'application/json', // Indico che passerò un json
                    'X-CSRFToken':csrftoken // Inserisco il token CSFR
                },
                body:JSON.stringify(// Corpo della richiesta dove passo i paramentri
                                        snapshot_json
                                   )
            }
            ).then(function(response){ // Funzione che lavora con i dati ricevuti in risposta
                document.getElementById("save-status").style.display = "block";
            })
        })

        function redirectAuthorDetail(authorScopusId){
            var url = '{% url 'frontend:author-details' "replace_id" %}' // Creo la URL con groupId replace_id
            url = url.replace('replace_id', authorScopusId) // sostituisco replace_id con l'id del group
            console.log("URL: ", url) // Scrittura di debug
            window.open(url, "_self") // Apertura della pagina nella stessa tab
        }
    </script>
{% endblock other %}