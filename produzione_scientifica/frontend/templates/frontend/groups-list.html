{% extends 'base.html' %} <!-- estendo il file base.html (Scheletro) -->

{% block title %}Lista dei Gruppi{% endblock title %} <!-- estensione titolo -->

{% block onload %}
    {% if user.is_authenticated %} 
       onload="buildGroupList();"
    {% endif %}
{% endblock onload %} <!-- Estensione funzione onload -->


{% block content %} <!-- Estensione contenuto del body -->
    {% if user.is_authenticated %}
        <div id="items-container">
            <div class="element-wrapper">
                <h2>Gestione dei gruppi</h2>
            </div>
            <div id="form-wrapper">
                <form id="form"> <!-- Form tramite la quale creo / modifico un gruppo -->
                    <div class="flex-wrapper">
                        <div style="flex: 6">
                            <input id="name" class="form-control" type="text" name="name" placeholder="Nome del Gruppo">
                            <textarea id="other-info" class="form-control" name="other-info" placeholder="Informazioni aggiuntive"  maxlength="200"></textarea>
                        </div>
                        <div style="flex: 1">
                            <input id="submit" class="btn" type="submit">
                        </div>
                    </div>
                </form>
            </div>
            <div id="item-wrapper">
                Caricamento dei gruppi in corso...
                <!-- Tramite la funzione buildGroupList() popolerò questo div con i gruppi -->
            </div>	
        </div>
    {% else %}
        {% include 'components/not_logged.html' %} <!-- Link login e registrazione -->
    {% endif %}
{% endblock content %}

{% block other %} <!-- Estensione -->
    <script type="text/javascript">
        function getCookie(name) { // Dato il nome del cookie mi restituisce il valore
            var cookieValue = null
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';')
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim()
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken'); // Valore del Token CSFR per effettuare le chiamate API con metodo diverso dalla GET
        var activeGroup = null

        function buildGroupList(){ // Populo il div chiamato item-wrapper con i gruppi creati dall'utente
            var wrapper = document.getElementById('item-wrapper');
            wrapper.innerHTML=""
            var url = "{% url 'api:groups-list' %}"; // URL della API che restituisce la lista dei gruppi

            fetch(url) // Chiamata
            .then((resp) => resp.json()) // Conversione in JSON della risposta
            .then(function(data){ // Funzione che lavora coi dati della risposta convertiti
                console.log('Gruppi:', data) // Scrittura di debug
        
                var lista = data
                if(lista.length==0) // Non ci sono gruppi
                    wrapper.innerHTML = `   
                                            <div class="element-wrapper">
                                                <h2>Non sono ancora presenti gruppi.</h2>
                                                <span>Comincia creandone uno</span>
                                            </div>
                                        `
                else {                                                        
                    for(var i in lista){ // Ciclo fra i gruppi
                        var item = `
                                    <div id="group-${lista[i].id}" class="element-wrapper flex-wrapper">
                                        <div style="flex:7">
                                            <span class="name link-td">${lista[i].name}</span>
                                        </div>
                                        <div style="flex:2">
                                            <button class="btn btn-sm btn-outline-info edit">Modifica </button>
                                        </div>
                                        <div style="flex:2">
                                            <button class="btn btn-sm btn-outline-dark delete">Elimina</button>
                                        </div>
                                    </div>
                                ` // Creazione dell'elemento contenente nome del gruppo e bottoni per la modifica / eliminazione
                        wrapper.innerHTML += item; // Aggiunta dell'elemento al div
                    }

                    for(var i in lista){ // Ciclo fra i gruppi
                        var editBtn = document.getElementsByClassName('edit')[i]
                        var deleteBtn = document.getElementsByClassName('delete')[i]
                        var name = document.getElementsByClassName('name')[i]

                        editBtn.addEventListener('click', (function(group){ // Aggiungo il listener sull'evento di click del bottone Edit
                            return function(){
                                editGroup(group)
                            }
                        })(lista[i]))

                        deleteBtn.addEventListener('click', (function(group){ // Aggiungo il listener sull'evento di click del bottone Delete
                            return function(){
                                deleteGroup(group)
                            }
                        })(lista[i]))

                        name.addEventListener('click', (function(group){ // Aggiungo il listener sull'evento di click del testo contenente il nome
                            return function(){
                                redirectGroupDetail(group)
                            }
                        })(lista[i]))
                    }
                }
            })
        }

        // Sovrascrivo il comportamento successivo al submit della form chiamata form-wrapper
        var form = document.getElementById('form-wrapper')
        form.addEventListener('submit', function(e){ // Aggiungo il listener sull'evento di submit
            e.preventDefault() // Evito che effettui il submit di default
            console.log('Form submitted') // Scrittura di debug
            var url = '{% url 'api:group-create' %}' // URL dell'API che crea un gruppo
            if(activeGroup != null) { // E' un update (NON una create)
                var url = '{% url 'api:group-update' "replace_id" %}' // Creo la URL con groupId replace_id
                url = url.replace('replace_id', activeGroup.id) // sostituisco replace_id con l'id del group
                console.log("URL: ", url)
                activeGroup = null
            }
            var name = document.getElementById('name').value // valore del campo name
            var other_info = document.getElementById('other-info').value // valore del campo other_info
            
            fetch(url, { // Chiamata
                method:'POST', // Metodo
                headers:{
                    'Content-type':'application/json', // Indico che passerò un json
                    'X-CSRFToken':csrftoken // Inserisco il token CSFR
                },
                body:JSON.stringify({ // Corpo della richiesta dove passo i paramentri
                                        "name":name,
                                        "other_info":other_info
                                    })
            }
            ).then(function(response){ // Funzione che lavora con i dati ricevuti in risposta
                buildGroupList(); // Ricreo la lista degli autori
                document.getElementById('form').reset() // Svuoto il contenuto della form
                
            })
        })

        function editGroup(group) {
            console.log("Update Cliccato: ", group) // Scrittura di debug
            activeGroup = group
            document.getElementById('name').value = group.name
            document.getElementById('other-info').value = group.other_info
        }

        function deleteGroup(group){
            console.log('Eliminazione Cliccata: ', group)
            var url = '{% url 'api:group-delete' "replace_id" %}' // Creo la URL con groupId replace_id
            url = url.replace('replace_id', group.id) // sostituisco replace_id con l'id del group
            console.log("URL: ", url)
            fetch(url,{
                method: 'DELETE',
                headers: {
                    'Content-type':'application/json', // Indico che passerò un json
                    'X-CSRFToken':csrftoken // Inserisco il token CSFR
                }
            }).then((response)=>{
                element = document.getElementById("group-"+group.id)
                element.remove()
                document.getElementById('form').reset()
                //buildGroupList()
            })
        }

        function redirectGroupDetail(group){
            var url = '{% url 'frontend:authors-list' "replace_id" %}' // Creo la URL con groupId replace_id
            url = url.replace('replace_id', group.id) // sostituisco replace_id con l'id del group
            console.log("URL: ", url)
            window.open(url, "_self") // Apertura della pagina nella stessa tab
        }
    </script>
{% endblock other %}